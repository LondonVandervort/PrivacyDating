<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Dating Platform - Confidential Matchmaking System</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #333;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(72, 219, 251, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(253, 203, 110, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
        }

        .wallet-section {
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.5);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            box-shadow: 0 10px 30px rgba(253, 203, 110, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 15px 40px rgba(253, 203, 110, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
            box-shadow: 0 10px 30px rgba(72, 219, 251, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 15px 40px rgba(72, 219, 251, 0.5);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.1);
            background: white;
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab:hover {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }

        .tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.08);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
            border-radius: 3px 3px 0 0;
            box-shadow: 0 -2px 10px rgba(255, 107, 107, 0.5);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-profile {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .match-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 15px;
            border-left: 5px solid #ff6b6b;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .match-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-left-width: 8px;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
        }

        .message.sent {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            margin-left: 20%;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }

        .message.received {
            background: linear-gradient(135deg, #e1e8ed 0%, #f1f3f5 100%);
            margin-right: 20%;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #fdcb6e, #48dbfb);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .privacy-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .privacy-badge:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .privacy-badge i {
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-heart"></i> Private Dating Platform</h1>
            <p>Confidential Matchmaking System powered by Zama FHE Technology</p>
            <div style="margin-top: 15px;">
                <span class="privacy-badge">
                    <i class="fas fa-lock"></i> Fully Encrypted
                </span>
                <span class="privacy-badge">
                    <i class="fas fa-user-secret"></i> Anonymous Matching
                </span>
                <span class="privacy-badge">
                    <i class="fas fa-shield-alt"></i> Privacy Protected
                </span>
            </div>
        </div>

        <!-- Wallet Connection -->
        <div class="card wallet-section">
            <div id="walletStatus">
                <button id="connectWallet" class="btn">
                    <i class="fas fa-wallet"></i> Connect Wallet
                </button>
            </div>
        </div>

        <!-- Main Application Area -->
        <div id="mainApp" style="display: none;">
            <!-- Navigation Tabs -->
            <div class="card">
                <div class="tabs">
                    <div class="tab active" data-tab="profile">
                        <i class="fas fa-user"></i> Profile
                    </div>
                    <div class="tab" data-tab="browse">
                        <i class="fas fa-search"></i> Browse
                    </div>
                    <div class="tab" data-tab="matches">
                        <i class="fas fa-heart"></i> My Matches
                    </div>
                    <div class="tab" data-tab="chat">
                        <i class="fas fa-comments"></i> Chat Rooms
                    </div>
                    <div class="tab" data-tab="stats">
                        <i class="fas fa-chart-bar"></i> Platform Stats
                    </div>
                </div>

                <!-- Profile Tab -->
                <div id="profile" class="tab-content active">
                    <h3><i class="fas fa-user-edit"></i> Create/Edit Profile</h3>

                    <div id="userProfileDisplay" style="display: none;">
                        <div class="user-profile">
                            <h4>Current Profile</h4>
                            <p id="profileInfo"></p>
                        </div>
                    </div>

                    <form id="profileForm">
                        <div class="form-group">
                            <label><i class="fas fa-birthday-cake"></i> Age (18-100)</label>
                            <input type="number" id="age" class="form-control" min="18" max="100" required>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-map-marker-alt"></i> Location Code (0-255)</label>
                            <input type="number" id="location" class="form-control" min="0" max="255" required>
                            <small>Location code will be encrypted</small>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-heart"></i> Interest Code (0-255)</label>
                            <input type="number" id="interests" class="form-control" min="0" max="255" required>
                            <small>Interest code will be encrypted</small>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Personality Type (0-255)</label>
                            <input type="number" id="personality" class="form-control" min="0" max="255" required>
                            <small>Personality type will be encrypted</small>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-edit"></i> Public Bio (max 500 characters)</label>
                            <textarea id="publicBio" class="form-control" rows="4" maxlength="500" placeholder="Tell us about yourself..."></textarea>
                        </div>

                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Register/Update Profile
                        </button>
                    </form>

                    <hr style="margin: 30px 0;">

                    <h4><i class="fas fa-cog"></i> Matching Preferences</h4>
                    <form id="preferencesForm">
                        <div class="form-group">
                            <label>Minimum Age</label>
                            <input type="number" id="minAge" class="form-control" min="18" max="100">
                        </div>

                        <div class="form-group">
                            <label>Maximum Age</label>
                            <input type="number" id="maxAge" class="form-control" min="18" max="100">
                        </div>

                        <div class="form-group">
                            <label>Preferred Location</label>
                            <input type="number" id="preferredLocation" class="form-control" min="0" max="255">
                        </div>

                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-heart"></i> Set Preferences
                        </button>
                    </form>
                </div>

                <!-- Browse Tab -->
                <div id="browse" class="tab-content">
                    <h3><i class="fas fa-search-heart"></i> Send Match Request</h3>

                    <form id="matchRequestForm">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Target User Address</label>
                            <input type="text" id="targetAddress" class="form-control" placeholder="0x..." required>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> Private Message (encrypted)</label>
                            <textarea id="privateMessage" class="form-control" rows="3" placeholder="Send a private message..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-paper-plane"></i> Send Match Request
                        </button>
                    </form>
                </div>

                <!-- My Matches Tab -->
                <div id="matches" class="tab-content">
                    <h3><i class="fas fa-heart"></i> My Matches</h3>
                    <button id="loadMatches" class="btn btn-success">
                        <i class="fas fa-refresh"></i> Load My Matches
                    </button>
                    <div id="matchesList"></div>
                </div>

                <!-- Chat Rooms Tab -->
                <div id="chat" class="tab-content">
                    <h3><i class="fas fa-comments"></i> Chat Rooms</h3>
                    <button id="loadChats" class="btn btn-success">
                        <i class="fas fa-refresh"></i> Load My Chats
                    </button>

                    <div id="chatRoomsList"></div>

                    <div id="selectedChatRoom" style="display: none;">
                        <h4>Chat Room: <span id="chatRoomTitle"></span></h4>
                        <div id="chatMessages" class="chat-messages"></div>

                        <form id="messageForm">
                            <div class="form-group">
                                <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." required>
                            </div>
                            <button type="submit" class="btn">
                                <i class="fas fa-paper-plane"></i> Send Message
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Platform Stats Tab -->
                <div id="stats" class="tab-content">
                    <h3><i class="fas fa-chart-line"></i> Platform Statistics</h3>
                    <button id="loadStats" class="btn btn-success">
                        <i class="fas fa-refresh"></i> Refresh Stats
                    </button>

                    <div id="statsDisplay" class="stats-grid">
                        <!-- Statistics will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessages"></div>
    </div>

    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = "0x42955a0528bc9e91a812a603d3dd4d2c48455b45";
        const CONTRACT_ABI = [
            // State variables
            "function owner() external view returns (address)",
            "function userCount() external view returns (uint256)",
            "function matchCount() external view returns (uint256)",

            // User management functions
            "function registerUser(uint8 _age, uint8 _location, uint8 _interests, uint8 _personality, string memory _publicBio) external",
            "function setMatchingPreferences(uint8 _minAge, uint8 _maxAge, uint8 _preferredLocation) external",
            "function updateLookingForMatch(bool _isLooking) external",
            "function updatePublicBio(string memory _newBio) external",
            "function deactivateAccount() external",

            // Matching system functions
            "function sendMatchRequest(address _target, string memory _encryptedMessage) external",

            // Chat system functions
            "function sendMessage(bytes32 _chatRoomId, string memory _encryptedMessage) external",
            "function getChatMessages(bytes32 _chatRoomId, uint256 _offset, uint256 _limit) external view returns (string[] memory messages, address[] memory senders)",

            // Query functions
            "function getUserProfile(address _user) external view returns (bool isActive, string memory publicBio, uint256 registrationTime, bool isLookingForMatch)",
            "function getUserMatches(address _user) external view returns (uint256[] memory)",
            "function getUserChats(address _user) external view returns (bytes32[] memory)",
            "function getChatRoomInfo(bytes32 _chatRoomId) external view returns (address user1, address user2, bool isActive, uint256 creationTime, uint256 messageCount)",
            "function getPlatformStats() external view returns (uint256 totalUsers, uint256 totalMatches, uint256 activeUsers)",

            // Admin functions
            "function adminDeactivateUser(address _user) external",

            // Events
            "event UserRegistered(address indexed user, uint256 timestamp)",
            "event MatchRequested(address indexed requester, address indexed target, uint256 matchId)",
            "event MutualMatchFound(address indexed user1, address indexed user2, bytes32 chatRoomId)",
            "event ChatRoomCreated(bytes32 indexed chatRoomId, address indexed user1, address indexed user2)",
            "event MessageSent(bytes32 indexed chatRoomId, address indexed sender)",
            "event ProfileUpdated(address indexed user)"
        ];

        // Global variables
        let provider, signer, contract, userAddress;
        let currentChatRoom = null;

        // Initialize after page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        // Initialize application
        async function initializeApp() {
            // Check if ethers library is loaded
            if (typeof ethers === 'undefined') {
                showMessage('Loading ethers library, please wait...', 'loading');
                // Wait and retry
                setTimeout(initializeApp, 1000);
                return;
            }

            // Check MetaMask
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed');

                // Check if already connected
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    } else {
                        showMessage('Please click Connect Wallet button', 'info');
                    }
                } catch (error) {
                    console.error('Failed to check account connection:', error);
                }
            } else {
                showMessage('Please install MetaMask wallet', 'error');
                return;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Use event delegation for wallet connection button
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'connectWallet') {
                    connectWallet();
                }
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Form submissions
            document.getElementById('profileForm').addEventListener('submit', handleProfileSubmit);
            document.getElementById('preferencesForm').addEventListener('submit', handlePreferencesSubmit);
            document.getElementById('matchRequestForm').addEventListener('submit', handleMatchRequest);
            document.getElementById('messageForm').addEventListener('submit', handleSendMessage);

            // Button clicks
            document.getElementById('loadMatches').addEventListener('click', loadUserMatches);
            document.getElementById('loadChats').addEventListener('click', loadUserChats);
            document.getElementById('loadStats').addEventListener('click', loadPlatformStats);
        }

        // Connect wallet
        async function connectWallet() {
            console.log('Connect wallet button clicked!');
            try {
                showMessage('Connecting wallet...', 'loading');

                // Check contract address
                if (CONTRACT_ADDRESS === "0x0000000000000000000000000000000000000000") {
                    showMessage('Please deploy contract and update contract address first', 'error');
                    return;
                }

                // Request account permissions
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                // Create provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = accounts[0];

                // Check network
                const network = await provider.getNetwork();
                console.log('Current network:', network.name, 'chainId:', network.chainId);

                // Create contract instance
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Test contract connection
                try {
                    await contract.userCount();
                    console.log('Contract connection successful');
                } catch (contractError) {
                    console.error('Contract connection failed:', contractError);
                    showMessage('Contract connection failed, please check contract address and network', 'error');
                    return;
                }

                // Update UI
                updateWalletStatus(true);
                await loadUserProfile();

                showMessage('Wallet connected successfully!', 'success');

                // Show main application
                document.getElementById('mainApp').style.display = 'block';

            } catch (error) {
                console.error('Wallet connection failed:', error);
                showMessage('Wallet connection failed: ' + error.message, 'error');
            }
        }

        // Update wallet status
        function updateWalletStatus(connected) {
            const walletStatus = document.getElementById('walletStatus');
            if (connected) {
                walletStatus.innerHTML = `
                    <div class="status connected">
                        <i class="fas fa-check-circle"></i> Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}
                    </div>
                `;
            } else {
                walletStatus.innerHTML = `
                    <button id="connectWallet" class="btn">
                        <i class="fas fa-wallet"></i> Connect Wallet
                    </button>
                `;
            }
        }

        // Switch tab
        function switchTab(tabName) {
            // Update tab styles
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Switch content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // Handle profile submit
        async function handleProfileSubmit(event) {
            event.preventDefault();

            try {
                showMessage('Registering/updating profile...', 'loading');

                const age = document.getElementById('age').value;
                const location = document.getElementById('location').value;
                const interests = document.getElementById('interests').value;
                const personality = document.getElementById('personality').value;
                const publicBio = document.getElementById('publicBio').value;

                const tx = await contract.registerUser(age, location, interests, personality, publicBio);
                showMessage('Transaction submitted, waiting for confirmation...', 'loading');

                await tx.wait();
                showMessage('Profile updated successfully!', 'success');

                await loadUserProfile();

            } catch (error) {
                console.error('Profile update failed:', error);
                showMessage('Profile update failed: ' + error.message, 'error');
            }
        }

        // Handle preferences submit
        async function handlePreferencesSubmit(event) {
            event.preventDefault();

            try {
                showMessage('Setting preferences...', 'loading');

                const minAge = document.getElementById('minAge').value;
                const maxAge = document.getElementById('maxAge').value;
                const preferredLocation = document.getElementById('preferredLocation').value;

                const tx = await contract.setMatchingPreferences(minAge, maxAge, preferredLocation);
                await tx.wait();

                showMessage('Preferences set successfully!', 'success');

            } catch (error) {
                console.error('Setting preferences failed:', error);
                showMessage('Setting preferences failed: ' + error.message, 'error');
            }
        }

        // Handle match request
        async function handleMatchRequest(event) {
            event.preventDefault();

            try {
                showMessage('Sending match request...', 'loading');

                const targetAddress = document.getElementById('targetAddress').value;
                const privateMessage = document.getElementById('privateMessage').value;

                const tx = await contract.sendMatchRequest(targetAddress, privateMessage);
                await tx.wait();

                showMessage('Match request sent successfully!', 'success');

                document.getElementById('matchRequestForm').reset();

            } catch (error) {
                console.error('Send match request failed:', error);
                showMessage('Send match request failed: ' + error.message, 'error');
            }
        }

        // Handle send message
        async function handleSendMessage(event) {
            event.preventDefault();

            if (!currentChatRoom) {
                showMessage('Please select a chat room first', 'error');
                return;
            }

            try {
                const message = document.getElementById('messageInput').value;

                const tx = await contract.sendMessage(currentChatRoom, message);
                await tx.wait();

                document.getElementById('messageInput').value = '';
                showMessage('Message sent successfully!', 'success');

                // Refresh chat history
                await loadChatMessages(currentChatRoom);

            } catch (error) {
                console.error('Send message failed:', error);
                showMessage('Send message failed: ' + error.message, 'error');
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const profile = await contract.getUserProfile(userAddress);

                if (profile[0]) { // isActive
                    document.getElementById('userProfileDisplay').style.display = 'block';
                    document.getElementById('profileInfo').innerHTML = `
                        <strong>Bio:</strong> ${profile[1]}<br>
                        <strong>Registration Time:</strong> ${new Date(profile[2] * 1000).toLocaleString()}<br>
                        <strong>Looking for Match:</strong> ${profile[3] ? 'Yes' : 'No'}
                    `;
                }

            } catch (error) {
                console.error('Load user profile failed:', error);
            }
        }

        // Load user matches
        async function loadUserMatches() {
            try {
                showMessage('Loading matches...', 'loading');

                const matches = await contract.getUserMatches(userAddress);
                const matchesList = document.getElementById('matchesList');

                if (matches.length === 0) {
                    matchesList.innerHTML = '<p>No match records found</p>';
                } else {
                    matchesList.innerHTML = `<p>Found ${matches.length} matches</p>`;
                    // Here you can add more detailed match information display
                }

                showMessage('Matches loaded successfully', 'success');

            } catch (error) {
                console.error('Load matches failed:', error);
                showMessage('Load matches failed: ' + error.message, 'error');
            }
        }

        // Load user chats
        async function loadUserChats() {
            try {
                showMessage('Loading chats...', 'loading');

                const chats = await contract.getUserChats(userAddress);
                const chatRoomsList = document.getElementById('chatRoomsList');

                if (chats.length === 0) {
                    chatRoomsList.innerHTML = '<p>No chat rooms found</p>';
                } else {
                    let chatHtml = '<h4>Chat Room List:</h4>';
                    chats.forEach((chatId, index) => {
                        chatHtml += `
                            <div class="match-card">
                                <p><strong>Chat Room ${index + 1}:</strong> ${chatId.substring(0, 10)}...</p>
                                <button class="btn" onclick="selectChatRoom('${chatId}')">
                                    <i class="fas fa-comments"></i> Open Chat
                                </button>
                            </div>
                        `;
                    });
                    chatRoomsList.innerHTML = chatHtml;
                }

                showMessage('Chats loaded successfully', 'success');

            } catch (error) {
                console.error('Load chats failed:', error);
                showMessage('Load chats failed: ' + error.message, 'error');
            }
        }

        // Select chat room
        async function selectChatRoom(chatRoomId) {
            currentChatRoom = chatRoomId;
            document.getElementById('selectedChatRoom').style.display = 'block';
            document.getElementById('chatRoomTitle').textContent = chatRoomId.substring(0, 10) + '...';

            await loadChatMessages(chatRoomId);
        }

        // Load chat messages
        async function loadChatMessages(chatRoomId) {
            try {
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.innerHTML = '<div class="loading">Loading messages...</div>';

                // Here should call contract's getChatMessages method
                // For demo purposes, we display a placeholder
                messagesDiv.innerHTML = `
                    <div class="message received">
                        <p>Welcome to private chat room!</p>
                        <small>System message</small>
                    </div>
                `;

            } catch (error) {
                console.error('Load messages failed:', error);
                document.getElementById('chatMessages').innerHTML = '<p class="error">Failed to load messages</p>';
            }
        }

        // Load platform stats
        async function loadPlatformStats() {
            try {
                showMessage('Loading statistics...', 'loading');

                const stats = await contract.getPlatformStats();
                const statsDisplay = document.getElementById('statsDisplay');

                statsDisplay.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats[0]}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats[1]}</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats[2]}</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                `;

                showMessage('Statistics loaded successfully', 'success');

            } catch (error) {
                console.error('Load statistics failed:', error);
                showMessage('Load statistics failed: ' + error.message, 'error');
            }
        }

        // Show message
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('statusMessages');
            const messageId = 'msg-' + Date.now();

            let className = 'success';
            let icon = 'fas fa-check-circle';

            if (type === 'error') {
                className = 'error';
                icon = 'fas fa-exclamation-circle';
            } else if (type === 'loading') {
                className = 'loading';
                icon = 'fas fa-spinner fa-spin';
            }

            const messageHtml = `
                <div id="${messageId}" class="${className}">
                    <i class="${icon}"></i> ${message}
                </div>
            `;

            messagesDiv.innerHTML = messageHtml;

            // Auto clear message
            if (type !== 'loading') {
                setTimeout(() => {
                    const msgElement = document.getElementById(messageId);
                    if (msgElement) {
                        msgElement.remove();
                    }
                }, 5000);
            }
        }

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length > 0) {
                    location.reload();
                } else {
                    updateWalletStatus(false);
                    document.getElementById('mainApp').style.display = 'none';
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }
    </script>
</body>
</html>