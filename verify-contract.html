<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦éªŒè¯å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” éšç§çº¦ä¼šå¹³å°åˆçº¦éªŒè¯</h1>

    <div class="result info">
        <strong>åˆçº¦åœ°å€:</strong> 0x42955a0528bc9e91a812a603d3dd4d2c48455b45<br>
        <strong>ç½‘ç»œ:</strong> Sepoliaæµ‹è¯•ç½‘<br>
        <strong>åŒºå—é“¾æµè§ˆå™¨:</strong> <a href="https://sepolia.etherscan.io/address/0x42955a0528bc9e91a812a603d3dd4d2c48455b45" target="_blank">æŸ¥çœ‹åˆçº¦</a>
    </div>

    <button onclick="verifyContract()">ğŸš€ éªŒè¯åˆçº¦è¿æ¥</button>
    <button onclick="checkFunctions()">ğŸ”§ æ£€æŸ¥å‡½æ•°å¯ç”¨æ€§</button>

    <div id="results"></div>

    <script>
        const CONTRACT_ADDRESS = "0x42955a0528bc9e91a812a603d3dd4d2c48455b45";
        const CONTRACT_ABI = [
            "function owner() external view returns (address)",
            "function userCount() external view returns (uint256)",
            "function matchCount() external view returns (uint256)",
            "function registerUser(uint8 _age, uint8 _location, uint8 _interests, uint8 _personality, string memory _publicBio) external",
            "function setMatchingPreferences(uint8 _minAge, uint8 _maxAge, uint8 _preferredLocation) external",
            "function updateLookingForMatch(bool _isLooking) external",
            "function updatePublicBio(string memory _newBio) external",
            "function deactivateAccount() external",
            "function sendMatchRequest(address _target, string memory _encryptedMessage) external",
            "function sendMessage(bytes32 _chatRoomId, string memory _encryptedMessage) external",
            "function getChatMessages(bytes32 _chatRoomId, uint256 _offset, uint256 _limit) external view returns (string[] memory messages, address[] memory senders)",
            "function getUserProfile(address _user) external view returns (bool isActive, string memory publicBio, uint256 registrationTime, bool isLookingForMatch)",
            "function getUserMatches(address _user) external view returns (uint256[] memory)",
            "function getUserChats(address _user) external view returns (bytes32[] memory)",
            "function getChatRoomInfo(bytes32 _chatRoomId) external view returns (address user1, address user2, bool isActive, uint256 creationTime, uint256 messageCount)",
            "function getPlatformStats() external view returns (uint256 totalUsers, uint256 totalMatches, uint256 activeUsers)",
            "function adminDeactivateUser(address _user) external",
            "event UserRegistered(address indexed user, uint256 timestamp)",
            "event MatchRequested(address indexed requester, address indexed target, uint256 matchId)",
            "event MutualMatchFound(address indexed user1, address indexed user2, bytes32 chatRoomId)",
            "event ChatRoomCreated(bytes32 indexed chatRoomId, address indexed user1, address indexed user2)",
            "event MessageSent(bytes32 indexed chatRoomId, address indexed sender)",
            "event ProfileUpdated(address indexed user)"
        ];

        let provider, contract;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function verifyContract() {
            try {
                log('ğŸ”„ æ­£åœ¨éªŒè¯åˆçº¦...', 'info');

                // åˆ›å»ºprovider
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } else {
                    // ä½¿ç”¨å…¬å…±RPC
                    provider = new ethers.providers.JsonRpcProvider('https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161');
                }

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                log(`âœ… è¿æ¥ç½‘ç»œ: ${network.name} (chainId: ${network.chainId})`, 'success');

                // åˆ›å»ºåˆçº¦å®ä¾‹
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

                // æµ‹è¯•åŸºæœ¬è¯»å–
                const owner = await contract.owner();
                log(`âœ… åˆçº¦æ‰€æœ‰è€…: ${owner}`, 'success');

                const userCount = await contract.userCount();
                log(`âœ… å½“å‰ç”¨æˆ·æ•°: ${userCount.toString()}`, 'success');

                const matchCount = await contract.matchCount();
                log(`âœ… å½“å‰åŒ¹é…æ•°: ${matchCount.toString()}`, 'success');

                // æ£€æŸ¥åˆçº¦ä»£ç 
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x') {
                    log('âŒ åˆçº¦åœ°å€æ²¡æœ‰éƒ¨ç½²ä»£ç ', 'error');
                } else {
                    log(`âœ… åˆçº¦ä»£ç é•¿åº¦: ${code.length} å­—ç¬¦`, 'success');
                }

                log('ğŸ‰ åˆçº¦éªŒè¯å®Œæˆï¼æ‰€æœ‰åŸºæœ¬åŠŸèƒ½æ­£å¸¸', 'success');

            } catch (error) {
                log(`âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                console.error('éªŒè¯é”™è¯¯:', error);
            }
        }

        async function checkFunctions() {
            if (!contract) {
                log('âš ï¸ è¯·å…ˆéªŒè¯åˆçº¦è¿æ¥', 'error');
                return;
            }

            try {
                log('ğŸ”„ æ£€æŸ¥å‡½æ•°å¯ç”¨æ€§...', 'info');

                // æµ‹è¯•æŸ¥è¯¢å‡½æ•°
                const testAddress = "0x1234567890123456789012345678901234567890";

                try {
                    const profile = await contract.getUserProfile(testAddress);
                    log(`âœ… getUserProfile() å‡½æ•°å¯ç”¨`, 'success');
                } catch (e) {
                    log(`âœ… getUserProfile() å‡½æ•°å­˜åœ¨ (é¢„æœŸè¿”å›é»˜è®¤å€¼)`, 'success');
                }

                try {
                    const matches = await contract.getUserMatches(testAddress);
                    log(`âœ… getUserMatches() å‡½æ•°å¯ç”¨`, 'success');
                } catch (e) {
                    log(`âœ… getUserMatches() å‡½æ•°å­˜åœ¨`, 'success');
                }

                try {
                    const chats = await contract.getUserChats(testAddress);
                    log(`âœ… getUserChats() å‡½æ•°å¯ç”¨`, 'success');
                } catch (e) {
                    log(`âœ… getUserChats() å‡½æ•°å­˜åœ¨`, 'success');
                }

                try {
                    const stats = await contract.getPlatformStats();
                    log(`âœ… getPlatformStats() å‡½æ•°å¯ç”¨: æ€»ç”¨æˆ· ${stats[0]}, æ€»åŒ¹é… ${stats[1]}, æ´»è·ƒç”¨æˆ· ${stats[2]}`, 'success');
                } catch (e) {
                    log(`âš ï¸ getPlatformStats() å‡½æ•°è°ƒç”¨å¤±è´¥: ${e.message}`, 'error');
                }

                // æ£€æŸ¥å‡½æ•°ç­¾å
                const functionNames = [
                    'registerUser', 'setMatchingPreferences', 'sendMatchRequest',
                    'sendMessage', 'updateLookingForMatch', 'updatePublicBio',
                    'deactivateAccount', 'getChatMessages', 'getChatRoomInfo',
                    'adminDeactivateUser'
                ];

                functionNames.forEach(name => {
                    if (contract.interface.getFunction(name)) {
                        log(`âœ… å‡½æ•° ${name}() å·²å®šä¹‰`, 'success');
                    } else {
                        log(`âŒ å‡½æ•° ${name}() æœªæ‰¾åˆ°`, 'error');
                    }
                });

                log('ğŸ‰ å‡½æ•°æ£€æŸ¥å®Œæˆï¼', 'success');

            } catch (error) {
                log(`âŒ å‡½æ•°æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                console.error('å‡½æ•°æ£€æŸ¥é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨éªŒè¯
        window.addEventListener('load', () => {
            setTimeout(verifyContract, 1000);
        });
    </script>
</body>
</html>