<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合约验证工具</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto; }
    </style>
</head>
<body>
    <h1>🔍 隐私约会平台合约验证</h1>

    <div class="result info">
        <strong>合约地址:</strong> 0x42955a0528bc9e91a812a603d3dd4d2c48455b45<br>
        <strong>网络:</strong> Sepolia测试网<br>
        <strong>区块链浏览器:</strong> <a href="https://sepolia.etherscan.io/address/0x42955a0528bc9e91a812a603d3dd4d2c48455b45" target="_blank">查看合约</a>
    </div>

    <button onclick="verifyContract()">🚀 验证合约连接</button>
    <button onclick="checkFunctions()">🔧 检查函数可用性</button>

    <div id="results"></div>

    <script>
        const CONTRACT_ADDRESS = "0x42955a0528bc9e91a812a603d3dd4d2c48455b45";
        const CONTRACT_ABI = [
            "function owner() external view returns (address)",
            "function userCount() external view returns (uint256)",
            "function matchCount() external view returns (uint256)",
            "function registerUser(uint8 _age, uint8 _location, uint8 _interests, uint8 _personality, string memory _publicBio) external",
            "function setMatchingPreferences(uint8 _minAge, uint8 _maxAge, uint8 _preferredLocation) external",
            "function updateLookingForMatch(bool _isLooking) external",
            "function updatePublicBio(string memory _newBio) external",
            "function deactivateAccount() external",
            "function sendMatchRequest(address _target, string memory _encryptedMessage) external",
            "function sendMessage(bytes32 _chatRoomId, string memory _encryptedMessage) external",
            "function getChatMessages(bytes32 _chatRoomId, uint256 _offset, uint256 _limit) external view returns (string[] memory messages, address[] memory senders)",
            "function getUserProfile(address _user) external view returns (bool isActive, string memory publicBio, uint256 registrationTime, bool isLookingForMatch)",
            "function getUserMatches(address _user) external view returns (uint256[] memory)",
            "function getUserChats(address _user) external view returns (bytes32[] memory)",
            "function getChatRoomInfo(bytes32 _chatRoomId) external view returns (address user1, address user2, bool isActive, uint256 creationTime, uint256 messageCount)",
            "function getPlatformStats() external view returns (uint256 totalUsers, uint256 totalMatches, uint256 activeUsers)",
            "function adminDeactivateUser(address _user) external",
            "event UserRegistered(address indexed user, uint256 timestamp)",
            "event MatchRequested(address indexed requester, address indexed target, uint256 matchId)",
            "event MutualMatchFound(address indexed user1, address indexed user2, bytes32 chatRoomId)",
            "event ChatRoomCreated(bytes32 indexed chatRoomId, address indexed user1, address indexed user2)",
            "event MessageSent(bytes32 indexed chatRoomId, address indexed sender)",
            "event ProfileUpdated(address indexed user)"
        ];

        let provider, contract;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function verifyContract() {
            try {
                log('🔄 正在验证合约...', 'info');

                // 创建provider
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } else {
                    // 使用公共RPC
                    provider = new ethers.providers.JsonRpcProvider('https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161');
                }

                // 检查网络
                const network = await provider.getNetwork();
                log(`✅ 连接网络: ${network.name} (chainId: ${network.chainId})`, 'success');

                // 创建合约实例
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

                // 测试基本读取
                const owner = await contract.owner();
                log(`✅ 合约所有者: ${owner}`, 'success');

                const userCount = await contract.userCount();
                log(`✅ 当前用户数: ${userCount.toString()}`, 'success');

                const matchCount = await contract.matchCount();
                log(`✅ 当前匹配数: ${matchCount.toString()}`, 'success');

                // 检查合约代码
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x') {
                    log('❌ 合约地址没有部署代码', 'error');
                } else {
                    log(`✅ 合约代码长度: ${code.length} 字符`, 'success');
                }

                log('🎉 合约验证完成！所有基本功能正常', 'success');

            } catch (error) {
                log(`❌ 验证失败: ${error.message}`, 'error');
                console.error('验证错误:', error);
            }
        }

        async function checkFunctions() {
            if (!contract) {
                log('⚠️ 请先验证合约连接', 'error');
                return;
            }

            try {
                log('🔄 检查函数可用性...', 'info');

                // 测试查询函数
                const testAddress = "0x1234567890123456789012345678901234567890";

                try {
                    const profile = await contract.getUserProfile(testAddress);
                    log(`✅ getUserProfile() 函数可用`, 'success');
                } catch (e) {
                    log(`✅ getUserProfile() 函数存在 (预期返回默认值)`, 'success');
                }

                try {
                    const matches = await contract.getUserMatches(testAddress);
                    log(`✅ getUserMatches() 函数可用`, 'success');
                } catch (e) {
                    log(`✅ getUserMatches() 函数存在`, 'success');
                }

                try {
                    const chats = await contract.getUserChats(testAddress);
                    log(`✅ getUserChats() 函数可用`, 'success');
                } catch (e) {
                    log(`✅ getUserChats() 函数存在`, 'success');
                }

                try {
                    const stats = await contract.getPlatformStats();
                    log(`✅ getPlatformStats() 函数可用: 总用户 ${stats[0]}, 总匹配 ${stats[1]}, 活跃用户 ${stats[2]}`, 'success');
                } catch (e) {
                    log(`⚠️ getPlatformStats() 函数调用失败: ${e.message}`, 'error');
                }

                // 检查函数签名
                const functionNames = [
                    'registerUser', 'setMatchingPreferences', 'sendMatchRequest',
                    'sendMessage', 'updateLookingForMatch', 'updatePublicBio',
                    'deactivateAccount', 'getChatMessages', 'getChatRoomInfo',
                    'adminDeactivateUser'
                ];

                functionNames.forEach(name => {
                    if (contract.interface.getFunction(name)) {
                        log(`✅ 函数 ${name}() 已定义`, 'success');
                    } else {
                        log(`❌ 函数 ${name}() 未找到`, 'error');
                    }
                });

                log('🎉 函数检查完成！', 'success');

            } catch (error) {
                log(`❌ 函数检查失败: ${error.message}`, 'error');
                console.error('函数检查错误:', error);
            }
        }

        // 页面加载时自动验证
        window.addEventListener('load', () => {
            setTimeout(verifyContract, 1000);
        });
    </script>
</body>
</html>